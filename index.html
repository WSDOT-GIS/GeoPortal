<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />
    <title>HPMS</title>
    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/2.1/js/dojo/dijit/themes/claro/claro.css" />
    <link rel="shortcut icon" href="http://www.wsdot.wa.gov/favicon.ico" />
    <style type="text/css">
        html, body
        {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        #mainContainer
        {
            width: 100%;
            height: 100%;
            margin: 0;
        }
        #map
        {
            border: 1px solid #000;
            padding: 0;
        }
        #layerList *
        {

        }
    </style>
    <script type="text/javascript">
        var djConfig = {
            parseOnLoad: true
        };
    </script>
    <script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=2.1"></script>
    <script type="text/javascript">
        dojo.require("dijit.dijit"); // optimize: load dijit layer
        dojo.require("dijit.layout.BorderContainer");
        dojo.require("dijit.layout.TabContainer");
        dojo.require("dijit.layout.ContentPane");
        dojo.require("dijit.Toolbar");
        dojo.require("dijit.form.DropDownButton");
        dojo.require("dijit.Dialog");
        dojo.require("dijit.Menu");

        dojo.require("esri.map");
        dojo.require("esri.virtualearth.VETiledLayer");
        dojo.require("esri.dijit.BasemapGallery");
        dojo.require("esri.arcgis.utils");
        dojo.require("esri.dijit.Legend");

        var map = null;
        var extents = null;
        var hpmsLayer;

        function handleLayerCheckboxClick() {
            // Get all of the checked checkboxes.
            var checkedBoxes = dojo.query("[id^=layer]:checked");
            var regex = /layer(\d+)checkbox/i
            var visibleLayers = dojo.map(checkedBoxes, function(item, index, array) { return Number(item.id.match(regex)[1]); });
            hpmsLayer.setVisibleLayers(visibleLayers);
            hpmsLayer.refresh();
        }
		
        function init() {
            var initExtent = new esri.geometry.Extent({
                "xmin": -13938444.981854893,
                "ymin": 5800958.950617068,
                "ymax": 6257746.631649259,
                "xmax": -12960051.019804686,
                "spatialReference": {
                    "wkid": 102100
                }
            });

            extents = {
                fullExtent: new esri.geometry.Extent({ "xmin": -14058520.2360666, "ymin": 5539437.0343901999, "ymax": 6499798.1008670302, "xmax": -12822768.6769759, "SpatialReference": { "wkid": 102100} }),
                regionExtents: {
                    olympic: new esri.geometry.Extent({ "xmin": -13916338.105957599, "ymin": 5871905.0123298904, "ymax": 6199038.6563490899, "xmax": -13514456.876250001, "SpatialReference": { "wkid": 102100} })
                    , southcentral: new esri.geometry.Extent({ "xmin": -13496692.0860734, "ymin": 5736869.3759225896, "ymax": 6051154.3698706599, "xmax": -13104714.794208299, "SpatialReference": { "wkid": 102100} })
                    , eastern: new esri.geometry.Extent({ "xmin": -13333876.337269399, "ymin": 5899530.2303624898, "ymax": 6226811.1176396199, "xmax": -12931415.4339041, "SpatialReference": { "wkid": 102100} })
                    , northcentral: new esri.geometry.Extent({ "xmin": -13539941.262809901, "ymin": 5920272.3836273896, "ymax": 6240012.4439044902, "xmax": -13139432.309131701, "SpatialReference": { "wkid": 102100} })
                    , northwest: new esri.geometry.Extent({ "xmin": -13774801.1336015, "ymin": 5949816.6953899199, "ymax": 6273649.11963824, "xmax": -13372864.399699001, "SpatialReference": { "wkid": 102100} })
                    , southwest: new esri.geometry.Extent({ "xmin": -13788347.769835001, "ymin": 5653732.0172728105, "ymax": 5967539.7998465998, "xmax": -13400171.8799819, "SpatialReference": { "wkid": 102100} })
                },
                countyExtents: {
                    thurston: new esri.geometry.Extent({ "xmin": -13712310.447719,"ymin": 5902426.25568371,"xmax": -13634694.6352888,"ymax": 5973211.36928832, "spatialReference": { "wkid": 102100}})
                }
            };

            map = new esri.Map("map", {
                logo: false,
                extent: initExtent,
                lods: [
		          { "level": 1, "resolution": 1222.99245256249, "scale": 4622324.434309 },
		          { "level": 2, "resolution": 611.49622628138, "scale": 2311162.217155 },
		          { "level": 3, "resolution": 305.748113140558, "scale": 1155581.108577 },
		          { "level": 4, "resolution": 152.874056570411, "scale": 577790.554289 },
		          { "level": 5, "resolution": 76.4370282850732, "scale": 288895.277144 },
		          { "level": 6, "resolution": 38.2185141425366, "scale": 144447.638572 },
		          { "level": 7, "resolution": 19.1092570712683, "scale": 72223.819286 },
		          { "level": 8, "resolution": 9.55462853563415, "scale": 36111.909643 },
		          { "level": 9, "resolution": 4.77731426794937, "scale": 18055.954822 },
		          { "level": 10, "resolution": 2.38865713397468, "scale": 9027.977411 },
		          { "level": 11, "resolution": 1.19432856685505, "scale": 4513.988705 }

		        ]
            });
            var initBasemap = new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer");
            map.addLayer(initBasemap);
            hpmsLayer = new esri.layers.ArcGISDynamicMapServiceLayer("http://hqolymgis11t/ArcGIS/rest/services/HPMS/HPMS/MapServer", { id: "hpms" });
            map.addLayer(hpmsLayer);

            createBasemapGallery();
            dojo.connect(dijit.byId('map'), 'resize', resizeMap);
            dojo.connect(hpmsLayer, "onLoad", null, setupToc);



            function LayerDescriptor(layerInfo, layerInfos) {
                /// <summary>Describes a layer: its ID, name and child layers.</summary>
                /// <param name="layerInfo" type="esri.layers.LayerInfo">The layer info that is being described.</param>
                /// <param name="layerInfos" type="esri.layers.LayerInfo[]">The array of layer infos that layerInfo belongs to.</param>
                /// <returns type="LayerDescriptor" />
                this.id = layerInfo.id;
                this.name = layerInfo.name;
                this.children = [];

                this.toListItem = function () {
                    /// <summary>Converts the layer descriptor into an HTML &lt;li&gt;</summary>
                    var output = "<li id='li" + this.id + "'><input id='layer" + this.id + "checkbox' type='checkbox' checked='checked' onclick='handleLayerCheckboxClick()'><label for='layer" + this.id + "checkbox'>" + this.name + "</label>";
                    if (this.children.length > 0) {
                        output += "<ul>";
                        for (var i in this.children) {
                            output += this.children[i].toListItem();
                        }
                        output += "</ul>"
                    }
                    output += "</li>";
                    return output;
                }

                if (layerInfo.subLayerIds !== null && layerInfo.subLayerIds.length > 0) {
                    for (var i in layerInfo.subLayerIds) {
                        this.children.push(new LayerDescriptor(layerInfos[layerInfo.subLayerIds[i]], layerInfos));
                    }
                }


            }

            function setupToc(layer) {
                /// <summary>Converts the layer's layerInfos into a table of contents &lt;ul&gt;.</summary>
                /// <param name="layer" type="esri.layers.Layer">A layer.</param>
                var topLevelLayerInfos = dojo.filter(layer.layerInfos, function (item, index, array) { return item.parentLayerId === -1; });
                console.debug(topLevelLayerInfos);
                var layerDefs = dojo.map(topLevelLayerInfos, function (item, index, array) { return new LayerDescriptor(layer.layerInfos[item.id], layer.layerInfos); });

                ////console.debug({ layerDefs: layerDefs });

                var ul = "<ul>";
                for (var i in layerDefs) {
                    ul += layerDefs[i].toListItem();
                }
                ul += "</ul>";

                dojo.place(ul, "layerList", "first");

                var legend = new esri.dijit.Legend({
                    map: map,
                    layerInfos: [{layer:layer}],
                }, "legend");
                legend.startup();
            }

            
        }

        function createBasemapGallery() {
            var basemaps = [
                new esri.dijit.Basemap({
                    layers: [new esri.dijit.BasemapLayer({ url: "http://hqolymgis17p/ArcGIS/rest/services/WSDOTBaseMap/WSDOTBaseMap/MapServer" })],
                    thumbnailUrl: "images/WsdotBasemapThumbnail.jpg",
                    title: "WSDOT Basemap"
                })
            ];
            var basemapGallery = new esri.dijit.BasemapGallery({
                showArcGISBasemaps: true,
                ////bingMapsKey: 'Av1bH4keF8rXBtxWOegklgWGCYYz8UGYvBhsWKuvc4Z15kT76xVFOERk8jkKEDvT',
                basemaps: basemaps,
                map: map
            }, "basemapGallery");

            basemapGallery.startup();

            dojo.connect(basemapGallery, "onError", function (msg) { console.log(msg) });
        }

        function resizeMap() {
            //resize the map when the browser resizes - view the 'Resizing and repositioning the map' section in
            //the following help topic for more details http://help.esri.com/EN/webapi/javascript/arcgis/help/jshelp_start.htm#jshelp/inside_guidelines.htm
            var resizeTimer;
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
                map.resize();
                map.reposition();
            }, 500);
        }

        //show map on load
        dojo.addOnLoad(init);
    </script>
</head>
<body class="claro">
    <div id="mainContainer" dojotype="dijit.layout.BorderContainer" design="headline" gutters="false">
        <div id="headerPane" dojotype="dijit.layout.ContentPane" region="top">
            <h1>HPMS</h1>
            <div id="toolbar1" dojotype="dijit.Toolbar">
                <div dojotype="dijit.form.DropDownButton" title="Switch Basemap">
                    <div>Switch Basemap</div>
                    <div dojotype="dijit.TooltipDialog">
                        <div id="basemapGallery">
                        </div>
                    </div>
                </div>
                <div dojotype="dijit.form.DropDownButton">
                    <div>Zoom to...</div>
                    <div dojotype="dijit.Menu">
                        <div onclick="map.setExtent(extents.fullExtent);" dojotype="dijit.MenuItem">Full Extent</div>
                	    <div dojotype="dijit.PopupMenuItem">
                            <span>Regions</span>
                            <div dojotype="dijit.Menu">
						        <div onclick="map.setExtent(extents.regionExtents.olympic);" dojotype="dijit.MenuItem">Olympic</div>
						        <div onclick="map.setExtent(extents.regionExtents.southcentral);" dojotype="dijit.MenuItem">Southcentral</div>
						        <div onclick="map.setExtent(extents.regionExtents.eastern);" dojotype="dijit.MenuItem">Eastern</div>
						        <div onclick="map.setExtent(extents.regionExtents.northcentral);" dojotype="dijit.MenuItem">Northcentral</div>
						        <div onclick="map.setExtent(extents.regionExtents.northwest);" dojotype="dijit.MenuItem">Northwest</div>
						        <div onclick="map.setExtent(extents.regionExtents.southwest);" dojotype="dijit.MenuItem">Southwest</div>
                            </div>
                        </div>
                        <div dojotype="dijit.PopupMenuItem">
                            <span>Counties</span>
                            <div dojotype="dijit.Menu">
                                <div id="thurstonZoomMenuItem" onclick="map.setExtent(extents.countyExtents.thurston);" dojotype="dijit.MenuItem">Thurston</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="map" dojotype="dijit.layout.ContentPane" region="center"></div>
        <div id="tabContainerPane" dojotype="dijit.layout.ContentPane" style="width:120px" region="left" splitter="true">
            <div id="tabContainer" dojotype="dijit.layout.TabContainer">
                <div id="tocPane" dojotype="dijit.layout.ContentPane"  title="Layers" >
                    <div id="layerList"></div>
                </div>
                <div id="legendPane" title="Legend" dojotype="dijit.layout.ContentPane">
                    <div id="legend"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
